<!-- stock -->


<%= include_gon %>

ichartで関連インデックス、寄与度上位銘柄や代表銘柄をiframeで表示
<script src="https://code.highcharts.com/stock/highstock.js"></script>
<script src="https://code.highcharts.com/stock/modules/exporting.js"></script>


<script>
$(function() {
    // $.getJSON('http://www.highcharts.com/samples/data/jsonp.php?filename=aapl-ohlcv.json&callback=?',
    //  function(data) {
      //model-db(active_record)からデータを取得してjsに渡す方法
      //http://qiita.com/s_nakamura/items/5d153f7d9db1b1190296
      // split the data set into ohlc and volume


      var historicals=gon.dow_historical
      console.log('historicals.count=', historicals.length)

      var ohlc = [],
          volume = [];
          // console.log("length=", dataLength)
          //alert("historicals = " + historicals.length);
      // alert(data[0][0]+","+data[1][0]+","+data[2][0]+","+data[3][0])
      // var unixtime=data[0][0]/1000
      // alert("original unix=" + unixtime)

      for (i = 0; i < historicals.length; i++) {
          // var ymd=String(historicals[i]["ymd"])
          // var year=ymd.substring(0, 4);
          // var month=ymd.substring(4, 6);
          // var day=ymd.substring(6, 8);
          // var ts = year+"-"+month+"-"+day+" 00:00:00";//"2011-10-14 00:00:00";
          // ts=String(ts)
          // var unixtime1=Date.parse( ts.replace( /-/g, '/') )
          var unixtime1 = historicals[i]["ymd"] * 1000

          // alert(ymd)
          // alert(year)
          // alert(month)
          // alert(day)
          // alert(ts)
          // alert( Date.parse( ts.replace( /-/g, '/') ) / 1000 );
          // alert("unixtime="+unixtime1)

          var open=historicals[i]["open"];
          var high=historicals[i]["high"];
          var low=historicals[i]["low"];
          var close=historicals[i]["close"];
          var volume1=historicals[i]["volume"];
          // console.log("ymd=",data[i][0]);
          // console.log("ymd2=", unixtime1);
          ohlc.push([
            unixtime1,
            open,
            high,
            low,
            close
              // data[i][0], // the date : unixtime
              // data[i][1], // open
              // data[i][2], // high
              // data[i][3], // low
              // data[i][4] // close
          ]);

          volume.push([
            unixtime1,
            volume1
              // data[i][0], // the date
              // data[i][5] // the volume
          ])


      }

      // set the allowed units for data grouping
      var groupingUnits = [[
          'week',                         // unit name
          [1]                             // allowed multiples
      ], [
          'month',
          [1, 2, 3, 4, 6]
      ]];

      // create the chart
      $('#dow_historical').highcharts('StockChart', {
          rangeSelector: {
              selected: 1
          },
          title: {
              text: historicals[0]["name"]//gon.user_name//arrayData[0]//gon.user_name
              // text: array[0]["20151230"]//gon.@pseries.
          },
          yAxis: [{
              title: {
                  text: 'price'
              },
              height: 170,
              lineWidth: 2
          }, {
              title: {
                  text: 'Volume'
              },
              top: 250,
              height: 40,
              offset: 0,
              lineWidth: 2
          }],

          series: [{
              type:'candlestick', // dowはohlcデータ取得できなかったため折れ線
              name: historicals[0].ticker,
              data: ohlc,
              dataGrouping: {
                  units: groupingUnits
              }
          }, {
              type: 'column',
              name: 'Volume',
              data: volume,
              yAxis: 1,
              dataGrouping: {
                  units: groupingUnits
              }
          }]
      });
    // });
});

</script>


<div class="row">
  <div class="col-xs-12 col-sm-12 col-md-9 col-lg-9">
    <!-- main contents field -->

    <div id = "deepredBack">
      <div class="row">
        <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
          <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-9 col-lg-9 col-md-offset-1 col-lg-offset-1">
              <br>
              <%= "ダウ平均(#{Time.at(@dow_now2[0].ymd.to_i).strftime('%-m月%-d日')})" %>
              <div id="nikkeiValue">
                <%= number_with_delimiter(@valuedow.to_d.floor(2), :delimiter => ',') %>
              </div>
              <% kigo = "+" %>
              <% if @diffdow.to_f < 0 %>
                <% kigo = "▲" %>
              <% end %>

              <div class="right">

                <%= "前日比: " + kigo + @diffdow.to_f.abs.to_s %>
                <%= "( " + kigo + @returndow.to_f.abs.to_s + " % )" %>
              </div>
              <br>
            </div>
          </div>
        </div>
      </div>
    </div>

    <br>

    <div class="row">
      <div class="col-xs-12 col-sm-12 col-md-10 col-lg-10 col-md-offset-1 col-lg-offset-1">


        <div id="dow_historical" style="width:100%; height:400px;"></div>
        <br>
      </div>
    </div>

  </div>
  <div class="col-xs-12 col-sm-12 col-md-3 col-lg-3">
    <%= render 'layouts/sidebar' %>
  </div>
</div>
